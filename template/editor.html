{% extends base.html %}

{% block title %}Editor{% end %}

{% block meta %}
  <!-- Firebase -->
  <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>

  <!-- CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.10.0/codemirror.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.10.0/codemirror.css" />

  <!-- ACE and theme files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js"></script>

  <!-- Firepad -->
  <script src="https://cdn.firebase.com/libs/firepad/1.3.0/firepad.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.8/clipboard.min.js"></script>

  <script src="{{root}}{{ static_url("firepad-userlist.js") }}"></script>
  <link rel="stylesheet" href="{{root}}{{ static_url("firepad-userlist.css") }}" />
  <link rel="stylesheet" href="{{root}}{{ static_url("firepad.css") }}" />

  <style>
    html { height: 100%; }
    body { margin: 0; height: 100%;}
  </style>
{% end %}

{% block content %}
  <div class="ui sidebar" style="background: #111;width:15em;">
    <div id="userlist"></div>
  </div>
  <div class="pusher" style="height: 100%;overflow:hidden;">
    <div class="menu bar" id="menu_bar">
        <div class="highlight unit" style="margin:0.5em 1em 0 1em!important;float:right;">
          {% include historys.part.html %}
        </div>
        <a href="{{root}}/" class="unit highlight" style="cursor:pointer;">
          <i class="left arrow icon"></i>
        </a>
        <div onclick="$('.ui.sidebar').sidebar('toggle');" class="unit highlight" style="cursor:pointer;">
          <i class="users icon"></i>
        </div>
        <div class="unit" class="unit highlight" style="cursor:pointer;"
          id="share_button">
          Edit with friends
        </div>
        <!--<div class="unit" id="mode_display">
        </div>-->
        {% if mode == 'c' %}
        <div class="unit">
          <div class="ui top left pointing dropdown highlight">
            <div class="text">Syntax</div>
            <div class="menu" id="syntax_menu">
              <div class="item" syntax="c_cpp">C/C++</div>
              <div class="item" syntax="java">Java</div>
              <div class="item" syntax="csharp">C#</div>
              <div class="item" syntax="objectivec">Objective-C</div>
              <div class="item" syntax="python">Python</div>
              <div class="item" syntax="javascript">Javascript</div>
              <div class="item" syntax="ruby">Ruby</div>
              <div class="item" syntax="swift">Swift</div>
              <div class="item" syntax="html">HTML</div>
              <div class="item" syntax="css">CSS</div>
              <div class="item" syntax="php">PHP</div>
              <div class="item" syntax="sql">SQL</div>
              <div class="item" syntax="autohotkey">Autohotkey</div>
              <div class="item" syntax="lisp">Lisp</div>
              <div class="item" syntax="lua">Lua</div>
            </div>
          </div>
        </div>
        <div class="unit">
          Theme:
          <div class="ui top left pointing dropdown highlight">
            <div class="text">Theme</div>
            <div class="menu" id="theme_menu">
              <div class="item" theme="monokai" theme-style="dark">Monokai</div>
              <div class="item" theme="mono_industrial" theme-style="dark">Mono Industrial</div>
              <div class="item" theme="tomorrow">Tomorrow</div>
              <div class="item" theme="tomorrow_night" theme-style="dark">Tomorrow Night</div>
              <div class="item" theme="twilight" theme-style="dark">Twilight</div>
              <div class="item" theme="textmate">Textmate</div>
              <div class="item" theme="solarized_light">Solarized Light</div>
              <div class="item" theme="solarized_dark" theme-style="dark">Solarized Dark</div>
              <div class="item" theme="github">Github</div>
              <div class="item" theme="dawn">Dawn</div>
              <div class="item" theme="terminal" theme-style="dark">Terminal</div>
              <div class="item" theme="xcode">Xcode</div>
              <div class="item" theme="crimson_editor">Crimson</div>
              <div class="item" theme="ambiance" theme-style="dark">Ambiance</div>
            </div>
          </div>
        </div>
        <div class="unit" id="text_warp_toggle" style="cursor:pointer;" onclick="warpmode.toggle()">
        </div>
        {% end %}
        <!--<div class="unit" onclick="$('#url_share_input').select();">
          <span>Collaborate with friends:</span>
          <div class="ui transparent input" style="width:20em;">

          </div>
        </div>-->
    </div>
    <div id="firepad" style="height:100%;"></div>
  </div>

  <script>
    function load_theme()
    {
      var theme = 'monokai';
      if (Cookies.get('astnote-code-theme'))
        theme = Cookies.get('astnote-code-theme');
      set_theme(theme);
      var menu_item = $('#theme_menu .item[theme="'+theme+'"]');
      if (menu_item) menu_item.click();
    }
    function set_theme(theme)
    {
      var menu_item = $('#theme_menu .item[theme="'+theme+'"]');
      if (menu_item && menu_item.attr('theme-style') == 'dark')
        $('#menu_bar').addClass('dark');
      else
        $('#menu_bar').removeClass('dark');
      editor.setTheme("ace/theme/"+theme);
      Cookies.set('astnote-code-theme',theme,{ expires: 90 });
    }
    function load_syntax()
    {
      var lang = 'python';
      if (Cookies.get('astnote-code-syntax'))
        lang = Cookies.get('astnote-code-syntax');
      set_syntax(lang);
      var menu_item = $('#syntax_menu .item[syntax="'+lang+'"]');
      if (menu_item) menu_item.click();
    }
    function set_syntax(lang)
    {
      session.setMode("ace/mode/"+lang);
      Cookies.set('astnote-code-syntax',lang,{ expires: 10, path:window.location.pathname});
    }
    function resize_pad(){
      var height = $(window).height() - $('#menu_bar').height() - ($('.firepad-toolbar').height() || 0) - 8;
      $('#firepad').css('height',height).css('max-height',height);
    }
    function update_username(userName)
    {
      Cookies.set('astnote-user-name',userName,{ expires: 90, path:'{{root}}/'});
    }
    function update_color(userName)
    {
      Cookies.set('astnote-user-color',userName,{ expires: 90, path:'{{root}}/'});
    }
    function warpmode(value)
    {
      if (value != undefined)
      {
        warpmode.warp = value;
        session.setUseWrapMode(warpmode.warp);
        $('#text_warp_toggle').text(warpmode.warp?'Warp:On':'Warp:Off');
      }
      return warpmode.warp;
    }
    warpmode.toggle = function(){
      warpmode(!warpmode.warp);
    }
  </script>
  <script>
    $('.ui.dropdown').dropdown();
    $('#syntax_menu .item').on('click',function(){set_syntax($(this).attr('syntax'))});
    $('#theme_menu .item').on('click',function(){set_theme($(this).attr('theme'))});
    window.addEventListener('resize',resize_pad, true);
    $(resize_pad);

    var fireurl = '{{firebase}}/astnote/{{mode}}/{{name}}';
    var mode = '{{mode}}';

    var firepadRef = new Firebase(fireurl);
    var firepad = undefined;
    var userId = Cookies.get('astnote-user-id');
    var userName = Cookies.get('astnote-user-name');
    var userColor = Cookies.get('astnote-user-color');
    if (!userId || window.location.hash == '#new_user')
    {
      userId = Math.floor(Math.random() * 9999999999).toString();
      Cookies.set('astnote-user-id',userId,{ expires: 90, path:'{{root}}/'});
    }
    if (!userName || window.location.hash == '#new_user')
    {
      userName = 'Guset ' + Math.floor(Math.random() * 999).toString();
      update_username(userName);
    }
    if (!userColor || window.location.hash == '#new_user')
    {
      userColor = ramdom_hsv();
      update_color(userColor);
    }


    /// ---- Modes ---- ///
    if (mode == 'c')
    {
      //code
      $('#mode_display').text('Code');
      var editor = ace.edit("firepad");
      var session = editor.getSession();
      warpmode(true);
      session.setUseWorker(false);
      var firepad = Firepad.fromACE(firepadRef, editor);
      load_theme();
      load_syntax();
    }
    else if (mode == 'r')
    {
      //rich text
      $('#mode_display').text('Rich Text');
      var codeMirror = CodeMirror(document.getElementById('firepad'), { lineWrapping: true });
      firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
          { richTextToolbar: true, richTextShortcuts: true, userId: userId});
    }

    else
    {
      //plain text
      $('#mode_display').text('Plain Text');
      var codeMirror = CodeMirror(document.getElementById('firepad'), { lineWrapping: true });
      firepad = Firepad.fromCodeMirror(firepadRef, codeMirror, { userId: userId});
    }

    var firepadUserList = FirepadUserList.fromDiv(firepadRef.child('users'),
        document.getElementById('userlist'), userId, userName, userColor);
    /*
    firepad.on('ready', function() {
      if (firepad.isHistoryEmpty()) {
        firepad.setText('Check out the user list to the left!');
      }
    });*/
    var room_url = window.location.pathname;
    var room_history = access_cookies('history');
    var is_new_room = true;
    if (!room_history) room_history = [];
    if (room_history.length >= 7) room_history.shift();
    var room_index = room_history.indexOf(room_url);
    if (room_index > -1)
        room_history.splice(room_index, 1);
    room_history.push(room_url);
    access_cookies('history',room_history);
    access_cookies('prev',room_url);
    var clipboard = new Clipboard('#share_button');
    $('#share_button').attr('data-clipboard-text',window.location.origin + window.location.pathname);
    clipboard.on('success', function(e) {
      var orginal_content = $('#share_button').html();
      $('#share_button').text('Url Copied!').addClass('highlight');
      setTimeout(function() {
        $('#share_button').html(orginal_content).removeClass('highlight');
      },2000);
    });
  </script>
{% end %}

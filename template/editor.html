{% extends base.html %}

{% block title %}Editor{% end %}

{% block meta %}
  <!-- Firebase -->
  <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>

  <!-- CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.10.0/codemirror.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.10.0/codemirror.css" />

  <!-- ACE and theme files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/ace.js"></script>

  <!-- Firepad -->
  <script src="https://cdn.firebase.com/libs/firepad/1.3.0/firepad.min.js"></script>

  <script src="{{root}}{{ static_url("firepad-userlist.js") }}"></script>
  <link rel="stylesheet" href="{{root}}{{ static_url("firepad-userlist.css") }}" />
  <link rel="stylesheet" href="{{root}}{{ static_url("firepad.css") }}" />

  <style>
    html { height: 100%; }
    body { margin: 0; height: 100%; }
    .borderless.button
    {
      border:none !important;
      box-shadow:none !important;
    }
  </style>
{% end %}

{% block content %}
  <div class="ui sidebar" style="background: #111;">
    <div id="userlist"></div>
  </div>
  <div class="pusher" style="height: 100%;">
    <div style="padding-bottom:0.5em;border-bottom: 1px solid #c9c9c9;background:#fff">
        <a onclick="$('.ui.sidebar').sidebar('toggle');"
           style="display:inline-block;margin:0.5em 0 0 1em;color:#666;cursor:pointer;">
          <i class="users icon"></i>
          Online Editors
        </a>
        <a style="display:inline-block;margin:0.5em 0 0 1em;color:#9c9c9c;">
          Mode: <span id="mode_display" style="color:#555;"></span>
        </a>
        {% if mode == 'c' %}
        <a style="display:inline-block;margin:0.5em 0 0 1em;color:#9c9c9c;">
          Syntax: <span id="syntax_display" style="color:#555;"></span>
        </a>
        {% end %}
        <div onclick="$('#url_share_input').select();"
             style="color:#9c9c9c;display:inline-block;margin:0.5em 0 0 1em">
          <span>Edit with friends:</span>
          <div class="ui transparent input" style="width:20em;">
            <input type="text" id="url_share_input" readonly="readonly"
                   style="text-decoration:underline;color:#666;">
          </div>
        </div>
        <a style="display:inline-block;margin:0.5em 1em 0 1em;color:#9c9c9c;float:right;">
          {% include historys.part.html %}
        </a>
    </div>
    <div id="firepad" style="height:100%"></div>
  </div>

  <script>
    var fireurl = '{{firebase}}/astnote/{{mode}}/{{name}}';
    var mode = '{{mode}}';

    $('#url_share_input').val(window.location.origin + window.location.pathname);

    var firepadRef = new Firebase(fireurl);
    var firepad = undefined;
    var userId = Math.floor(Math.random() * 9999999999).toString();

    if (mode == 'c')
    {
      //code
      var lang = window.location.hash || 'python';
      $('#mode_display').text('Code');
      $('#syntax_display').text(lang[0].toUpperCase() + lang.slice(1).toLowerCase());
      var editor = ace.edit("firepad");
      editor.setTheme("ace/theme/solarized_light");
      var session = editor.getSession();
      session.setUseWrapMode(true);
      session.setUseWorker(false);
      try
      {
        session.setMode("ace/mode/"+lang);
      }
      catch(err)
      {
        consloe.log(err);
        alert('We may not support lanuage "'+lang[0].toUpperCase() + lang.slice(1).toLowerCase()+'" for Syntax highlighting, but you can still use the other functions.');
      }
      var firepad = Firepad.fromACE(firepadRef, editor);
    }
    else if (mode == 'r')
    {
      //rich text
      $('#mode_display').text('Rich Text');
      var codeMirror = CodeMirror(document.getElementById('firepad'), { lineWrapping: true });
      firepad = Firepad.fromCodeMirror(firepadRef, codeMirror,
          { richTextToolbar: true, richTextShortcuts: true, userId: userId});
    }

    else
    {
      //plain text
      $('#mode_display').text('Plain Text');
      var codeMirror = CodeMirror(document.getElementById('firepad'), { lineWrapping: true });
      firepad = Firepad.fromCodeMirror(firepadRef, codeMirror, { userId: userId});
    }

    var firepadUserList = FirepadUserList.fromDiv(firepadRef.child('users'),
        document.getElementById('userlist'), userId);
    /*
    firepad.on('ready', function() {
      if (firepad.isHistoryEmpty()) {
        firepad.setText('Check out the user list to the left!');
      }
    });*/
    var room_url = window.location.pathname;
    var room_history = access_cookies('history');
    var is_new_room = true;
    if (!room_history) room_history = [];
    if (room_history.length >= 7) room_history.shift();
    var room_index = room_history.indexOf(room_url);
    if (room_index > -1)
        room_history.splice(room_index, 1);
    room_history.push(room_url);
    access_cookies('history',room_history);
    access_cookies('prev',room_url);
  </script>
{% end %}
